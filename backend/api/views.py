from .serializers import RPSerializer
from .models import RP
# from .services import extract_text, extract_sectionwise_text
from rest_framework.views import APIView
from rest_framework.parsers import MultiPartParser, FormParser
from rest_framework.response import Response
from rest_framework import status
from .generateSummary import get_section_summary

# summ = {}

#dummy data
summ = {
    "0": {
        "heading": "Trajectory distributions a new description of movement for trajectory prediction. ",
        "1 Introduction": "A pedestrian’s trajectory is multimodal and closely depends on the person’s hearing vision touch houghts and personality and is also affected by other factors such as the static environment dynamic humanhuman interactions and planned destinations. Nevertheless pedestrians still can intuitively predict he future trajectories of others and adjust themselves for example when people walk in shopping malls streets and stations they quickly predict the trajectories of others so as to choose heir own route at the next moment and avoid collisions. The purpose of trajectory prediction is o enable machines such as robots selfdriving cars and intelligent tracking systems to have the ability o predict future trajectories based on historical rajectories. This is a fundamental but extremely in advance. In previous works researchers mainly focused on the following problems in trajectory prediction interaction between pedestrians 16 interaction between pedestrians and their environment 79 and multimodality 10 11. Other earlier works 13 17 18 made great progress in modeling the impact of humanhuman interactions. However great challenges still exist since most of this work achieves the purpose of modeling pedestrian interactions by combining hidden states. The lack of spatial information makes the problem of modeling interactions complicated and difficult. Specifically we use a probability density function to map the pedestrian coordinates xz yz to twodimensional gaussian distributions gxz yz. Moreover conveniently map all pedestrian’s trajectories at time t into a single twodimensional space with unique advantages in modeling humanhuman interactions. Based on the proposed trajectory distribution we further develop a new method called the social probability method for predicting robust and accurate firstly the inputs to our we cah pedestrian trajectories. 1 the current two pedestrians approaching each other. Positions of the pedestrians are no longer represented by fixed 2d coordinates but by gaussian probability distributions one for each trajectory. In summary the main contributions of this paper are as follows 1. Convolution operations on trajectory distributions allow better modeling of human human interactions. The rest of the paper is organized as follows. In section 4 we further present and analyse experimental results. Finally we conclude and discuss future directions in section 5. ",
        "2 Related work": "10 solved the trajectory prediction problem using generative adversarial networks gans 19 and considered the fact that pedestrian trajectories may have multiple plausible predictions. Sophie 8 combined semantic scene segmentation with gans to model trajectories. Multiverse 11 was a joint model to generate multiple plausible future trajectories \fusing multiscale location encodings and convolutional rnns over graphs. 14 15 20 also proposed probability networks to incorporate randomness into vehicle trajectory prediction. How ever these works all treat position information as twodimensional point coordinates for input into the prediction model doing so cannot completely describe the random behavior of pedestrians. Unlike these works we take a trajectory distribution transformed from the moving trajectory as input and generate multiple future trajectories. Methods 21 22 based on social force use the principle that attractive forces are used to guide people toward their destinations and repulsive forces are used to avoid collisions both humanhuman and humanobstacle. However alahi et al. Other approaches 1 10 23 24 used a social pooling layer to allow lstms to share hidden states. Thus methods based on the attention mechanism have emerged 3 8. Pedestrians can automatically perceive the importance of certain targets that affect their location in following time steps. Rsbg recursive social behavior graph 18 established a groupbased social interaction model to explore relationships that are not affected by spatial distance and a graph convolutional neural network 28 has also been applied to trajectory prediction. Recurrent neural networks and their derivatives lstms 29 and grus gated recurrent units 30 have proved their effectiveness in many fields such as machine translation 31 text generation 32 33 speech recognition 3436 and traffic flow prediction 37. Their convlstm model not only learns temporal relationships but also extracts spatial features using the convolution layer. ",
        "3 Approach": "In this section we first present our new pedestrian motion description the trajectory distribution which solves the problem of modeling multiple trajectories rom the data description level and then we propose a prediction model based on trajectory distributions o describe humanhuman interactions conveniently. The predicted future trajectory distribution is denoted y  y axe y where n is he number of pedestrians. The input trajectory of pedestrian i is defined as x  naiyi for time \fsteps  1lops and the future trajectory can be defined similarly as y  naty for time steps t  tobs1tobs2tprea where n represents a gaussian distribution. 32 trajectory distribution 821 mathematical definition supposing the feasible area for the pedestrians is q we represent the location of a single pedestrian at time ¢ as a probability distribution on 2. The location distribution at time t has the highest probability density at the center position x4 yz. 1 is set to x and jig is set to y. In twodimensional space a pedestrian trajectory is no longer a single point at time t but a probability distribution as shown in fig. Ci pa oy 822 integrating neighbor information at time t we denote the trajectory distribution of pedestrian i by pi. However the scene at time ¢ contains multiple pedestrians. Need to integrate the trajectory distributions of all pedestrians at time t into the same twodimensional probability space. Pe  maxppi i1n 2 where n is the number of pedestrians at time t. Convolutional lstm due to its unique structure the long and shortterm memory network lstm has great advantages in processing time sequence data. Moreover shi et al. Specifically the main operations are as follows iy  0waixt  wrihi1  wei e1  bi 3 fie  0wag xt  waghi1  wer 0c1  bp 4 er  fro cra t © tanhweex  wacht1  be 5 04  owaoxt  wrohi1  weo 0 ce  bo 6 hy  0 0 tanhc 7 where x is the input at time t and h and c are hidden state and cell state respectively. 4 f 04 are the gates of the convlstm. W is a weight matrix. “o” denotes the hadamard product. At time \fut az provides input to the module for calculation only when the input gate is activated. 34 social probability as we show in fig. Firstly we map the position information of all pedestrians at time ¢ into trajectory distributions. Therefore it is suitable for input to the convlstm model. Moreover  gly fa oyfrsp time t  pea ee trajectory distributlons are essentlally probability density distributions. 342 humanhuman interaction modeling the input to our model comprises the trajectory distributions of all pedestrians at time t integrated into one twodimensional space so modeling human human interactions is direct and expedient. As illustrated in fig. 4 after trajectory distributions are input into the model the convolutional layer extracts features in the twodimensional trajectory distribution to obtain the hidden state which is the feature vector in the rnnbased model. Therefore our model considers the locations of all pedestrians at time t considering humanhuman interactions without complex interaction modules. Since loss function time t1  bi  om ‘mb oo fig. Overview of the social probability method. \f convolution kernel 33 fig. Convolution operations on the trajectory distribution enable our method to model humanhuman interactions more intuitively and efficiently. Our model focuses on the specific probability density value rather than some highdimensional features such as style graphics or objects we use an l2 loss function to encourage our model to generate accurate probability density distributions lr2¥i ye  ye  yip 8 where ye and y are the predicted and ground truth trajectory distributions for person i at time t respectively. ",
        "4 Experiments": "41 datasets we validated the proposed model on the public eth 22 and ucy 45 datasets which are the widely used benchmarks in the field of trajectory prediction. They contain a total of 1536 labeled pedestrians in 4 different scenes. We use a leaveoneout approach to evaluate the performance of the model. \f40 implementation detalls five layers are used in the convlstm model and the hidden state channel size in each layer is 128 64 64 32 32 respectively. The kernel size of the convolutional layer is 3 x 3 and the padding is 1. We train our model using adam 46 with an initial learning rate of 0001. In the testing stage we sample 20 times from the trajectory distribution predicted by the model and select the best prediction in terms of euclidean distance for quantitative estimation. Linear a linear regression model which predicts the trajectory by minimizing the least square error. Plainlstm use the lstm model to predict the future trajectory. Socialgan 10 a trajectory prediction model trained with gan architecture is designed to improve existing models in terms of rationality diversity and prediction speed. The model pays attention to the feasibility of generating trajectory predictions using social rules. Socialganp 10 as socialgan but without the pooling mechanism. Sore d sn mterpretabie ramework based on gan for trajectory prediction. It uses two information sources the historical trajectories of all pedestrians in a scene and the scene contextual information from the scene image. Rsbg 18 a groupbased social interaction model to explore pedestrian relationships that are not affected by spatia a graph convolutional neural network is applied to trajectory prediction in this model. Next 7 multitask learning system that uses pedestrian behavior information and its surrounding scene environment to predict trajectory. Sociallstm and socialgan perform better than the linear method since they can handle interactions between pedestrians via the corresponding interaction module. Error metrics used are ade and fde for the task of predicting 12 future time steps method eth hotel univ zaral zara2 avg linear 133  294 039  072 082  159 062  121 077  148 079  159 plainlstm 109  214 086  191 061  131 041  088 052  111 070  152 sociallstm 1 109  235 079  176 067  140 047  100 056  117 072  154 socialgan 10 081  152 072  161 060  126 034  069 042  084 058  118 socialganp 10 087  162 067  137 076  152 035  068 042  084 061  121 sophie 8 070  143 076  167 054  124 030  063 038  078 054  115 rsbg 18 080  153 033  064 059  125 040  086 030  065 048  099 next 7 073  165 030  059 060  127 038  081 031  068 046  100 ours 074  122 049  085 063  123 042  078 038  070 053  095 \fthe imear model except im the case of the mule dataset with few pedestrians. This demonstrates that our method implicitly models interaction without complex interaction modules. This reflects that our method has more advantages in terms of predicting destinations. The successful samples show that the model can avoid obstacles in advance when interacting with others. Furthermore our method is also suitable for crowded scenes when multiple people are walking forward to the same or in different directions avoiding each other by following others or passing between them. The last row shows some unsuccessful examples. These examples have large gaps in predictions or go in the wrong direction. Another reason is that when pedestrians interact with their physical surroundings the model does not handle scene information. Above center representative examples where our method successfully predicts trajectories with small errors. \f444 lnuegtaalion of ltajecloty aislploullons as explained in section 32 we integrate the trajectory distributions of all pedestrians at time t into a single twodimensional probability space. Here we omit the other trajectory distributions to verify the ability of our model to capture interaction. The method with integration has clearly better ade and fde showing that integrating trajectory distributions provides the ability to model humanhuman interaction. Results are shown in fig. Ade fde full algorithm 074 122 our method without integration 086 164 comparison of different size 439 8080 100100 120120 150150 170170 200200 size made m fde fig. The blue line shows the trend of ade. Whue as the size decreases the trajectory distribution is incapable of modeling large enough amounts of data. ",
        "5 Conclusions": "In this paper we have proposed the concept of trajectory distributions with advantages in representing the randomness of trajectories and explored a new trajectory prediction method based on it.  experiments on public datasets show the effectiveness of our method. Our current work does not incorporate the physical environment but it is obvious that adding such information to our model is straightforward and convenient and is the direction of our future work. "
    },
    "1": {
        "heading": "Trajectory distributions a new description of movement for trajectory prediction. ",
        "1 Introduction": "A pedestrian’s trajectory is multimodal and closely depends on the person’s hearing vision touch houghts and personality and is also affected by other factors such as the static environment dynamic humanhuman interactions and planned destinations. Nevertheless pedestrians still can intuitively predict he future trajectories of others and adjust themselves for example when people walk in shopping malls streets and stations they quickly predict the trajectories of others so as to choose heir own route at the next moment and avoid collisions. The purpose of trajectory prediction is o enable machines such as robots selfdriving cars and intelligent tracking systems to have the ability o predict future trajectories based on historical rajectories. This is a fundamental but extremely in advance. In previous works researchers mainly focused on the following problems in trajectory prediction interaction between pedestrians 16 interaction between pedestrians and their environment 79 and multimodality 10 11. Other earlier works 13 17 18 made great progress in modeling the impact of humanhuman interactions. However great challenges still exist since most of this work achieves the purpose of modeling pedestrian interactions by combining hidden states. The lack of spatial information makes the problem of modeling interactions complicated and difficult. Specifically we use a probability density function to map the pedestrian coordinates xz yz to twodimensional gaussian distributions gxz yz. Moreover conveniently map all pedestrian’s trajectories at time t into a single twodimensional space with unique advantages in modeling humanhuman interactions. Based on the proposed trajectory distribution we further develop a new method called the social probability method for predicting robust and accurate firstly the inputs to our we cah pedestrian trajectories. 1 the current two pedestrians approaching each other. Positions of the pedestrians are no longer represented by fixed 2d coordinates but by gaussian probability distributions one for each trajectory. In summary the main contributions of this paper are as follows 1. Convolution operations on trajectory distributions allow better modeling of human human interactions. The rest of the paper is organized as follows. In section 4 we further present and analyse experimental results. Finally we conclude and discuss future directions in section 5. ",
        "2 Related work": "10 solved the trajectory prediction problem using generative adversarial networks gans 19 and considered the fact that pedestrian trajectories may have multiple plausible predictions. Sophie 8 combined semantic scene segmentation with gans to model trajectories. Multiverse 11 was a joint model to generate multiple plausible future trajectories \fusing multiscale location encodings and convolutional rnns over graphs. 14 15 20 also proposed probability networks to incorporate randomness into vehicle trajectory prediction. How ever these works all treat position information as twodimensional point coordinates for input into the prediction model doing so cannot completely describe the random behavior of pedestrians. Unlike these works we take a trajectory distribution transformed from the moving trajectory as input and generate multiple future trajectories. Methods 21 22 based on social force use the principle that attractive forces are used to guide people toward their destinations and repulsive forces are used to avoid collisions both humanhuman and humanobstacle. However alahi et al. Other approaches 1 10 23 24 used a social pooling layer to allow lstms to share hidden states. Thus methods based on the attention mechanism have emerged 3 8. Pedestrians can automatically perceive the importance of certain targets that affect their location in following time steps. Rsbg recursive social behavior graph 18 established a groupbased social interaction model to explore relationships that are not affected by spatial distance and a graph convolutional neural network 28 has also been applied to trajectory prediction. Recurrent neural networks and their derivatives lstms 29 and grus gated recurrent units 30 have proved their effectiveness in many fields such as machine translation 31 text generation 32 33 speech recognition 3436 and traffic flow prediction 37. Their convlstm model not only learns temporal relationships but also extracts spatial features using the convolution layer. ",
        "3 Approach": "In this section we first present our new pedestrian motion description the trajectory distribution which solves the problem of modeling multiple trajectories rom the data description level and then we propose a prediction model based on trajectory distributions o describe humanhuman interactions conveniently. The predicted future trajectory distribution is denoted y  y axe y where n is he number of pedestrians. The input trajectory of pedestrian i is defined as x  naiyi for time \fsteps  1lops and the future trajectory can be defined similarly as y  naty for time steps t  tobs1tobs2tprea where n represents a gaussian distribution. 32 trajectory distribution 821 mathematical definition supposing the feasible area for the pedestrians is q we represent the location of a single pedestrian at time ¢ as a probability distribution on 2. The location distribution at time t has the highest probability density at the center position x4 yz. 1 is set to x and jig is set to y. In twodimensional space a pedestrian trajectory is no longer a single point at time t but a probability distribution as shown in fig. Ci pa oy 822 integrating neighbor information at time t we denote the trajectory distribution of pedestrian i by pi. However the scene at time ¢ contains multiple pedestrians. Need to integrate the trajectory distributions of all pedestrians at time t into the same twodimensional probability space. Pe  maxppi i1n 2 where n is the number of pedestrians at time t. Convolutional lstm due to its unique structure the long and shortterm memory network lstm has great advantages in processing time sequence data. Moreover shi et al. Specifically the main operations are as follows iy  0waixt  wrihi1  wei e1  bi 3 fie  0wag xt  waghi1  wer 0c1  bp 4 er  fro cra t © tanhweex  wacht1  be 5 04  owaoxt  wrohi1  weo 0 ce  bo 6 hy  0 0 tanhc 7 where x is the input at time t and h and c are hidden state and cell state respectively. 4 f 04 are the gates of the convlstm. W is a weight matrix. “o” denotes the hadamard product. At time \fut az provides input to the module for calculation only when the input gate is activated. 34 social probability as we show in fig. Firstly we map the position information of all pedestrians at time ¢ into trajectory distributions. Therefore it is suitable for input to the convlstm model. Moreover  gly fa oyfrsp time t  pea ee trajectory distributlons are essentlally probability density distributions. 342 humanhuman interaction modeling the input to our model comprises the trajectory distributions of all pedestrians at time t integrated into one twodimensional space so modeling human human interactions is direct and expedient. As illustrated in fig. 4 after trajectory distributions are input into the model the convolutional layer extracts features in the twodimensional trajectory distribution to obtain the hidden state which is the feature vector in the rnnbased model. Therefore our model considers the locations of all pedestrians at time t considering humanhuman interactions without complex interaction modules. Since loss function time t1  bi  om ‘mb oo fig. Overview of the social probability method. \f convolution kernel 33 fig. Convolution operations on the trajectory distribution enable our method to model humanhuman interactions more intuitively and efficiently. Our model focuses on the specific probability density value rather than some highdimensional features such as style graphics or objects we use an l2 loss function to encourage our model to generate accurate probability density distributions lr2¥i ye  ye  yip 8 where ye and y are the predicted and ground truth trajectory distributions for person i at time t respectively. ",
        "4 Experiments": "41 datasets we validated the proposed model on the public eth 22 and ucy 45 datasets which are the widely used benchmarks in the field of trajectory prediction. They contain a total of 1536 labeled pedestrians in 4 different scenes. We use a leaveoneout approach to evaluate the performance of the model. \f40 implementation detalls five layers are used in the convlstm model and the hidden state channel size in each layer is 128 64 64 32 32 respectively. The kernel size of the convolutional layer is 3 x 3 and the padding is 1. We train our model using adam 46 with an initial learning rate of 0001. In the testing stage we sample 20 times from the trajectory distribution predicted by the model and select the best prediction in terms of euclidean distance for quantitative estimation. Linear a linear regression model which predicts the trajectory by minimizing the least square error. Plainlstm use the lstm model to predict the future trajectory. Socialgan 10 a trajectory prediction model trained with gan architecture is designed to improve existing models in terms of rationality diversity and prediction speed. The model pays attention to the feasibility of generating trajectory predictions using social rules. Socialganp 10 as socialgan but without the pooling mechanism. Sore d sn mterpretabie ramework based on gan for trajectory prediction. It uses two information sources the historical trajectories of all pedestrians in a scene and the scene contextual information from the scene image. Rsbg 18 a groupbased social interaction model to explore pedestrian relationships that are not affected by spatia a graph convolutional neural network is applied to trajectory prediction in this model. Next 7 multitask learning system that uses pedestrian behavior information and its surrounding scene environment to predict trajectory. Sociallstm and socialgan perform better than the linear method since they can handle interactions between pedestrians via the corresponding interaction module. Error metrics used are ade and fde for the task of predicting 12 future time steps method eth hotel univ zaral zara2 avg linear 133  294 039  072 082  159 062  121 077  148 079  159 plainlstm 109  214 086  191 061  131 041  088 052  111 070  152 sociallstm 1 109  235 079  176 067  140 047  100 056  117 072  154 socialgan 10 081  152 072  161 060  126 034  069 042  084 058  118 socialganp 10 087  162 067  137 076  152 035  068 042  084 061  121 sophie 8 070  143 076  167 054  124 030  063 038  078 054  115 rsbg 18 080  153 033  064 059  125 040  086 030  065 048  099 next 7 073  165 030  059 060  127 038  081 031  068 046  100 ours 074  122 049  085 063  123 042  078 038  070 053  095 \fthe imear model except im the case of the mule dataset with few pedestrians. This demonstrates that our method implicitly models interaction without complex interaction modules. This reflects that our method has more advantages in terms of predicting destinations. The successful samples show that the model can avoid obstacles in advance when interacting with others. Furthermore our method is also suitable for crowded scenes when multiple people are walking forward to the same or in different directions avoiding each other by following others or passing between them. The last row shows some unsuccessful examples. These examples have large gaps in predictions or go in the wrong direction. Another reason is that when pedestrians interact with their physical surroundings the model does not handle scene information. Above center representative examples where our method successfully predicts trajectories with small errors. \f444 lnuegtaalion of ltajecloty aislploullons as explained in section 32 we integrate the trajectory distributions of all pedestrians at time t into a single twodimensional probability space. Here we omit the other trajectory distributions to verify the ability of our model to capture interaction. The method with integration has clearly better ade and fde showing that integrating trajectory distributions provides the ability to model humanhuman interaction. Results are shown in fig. Ade fde full algorithm 074 122 our method without integration 086 164 comparison of different size 439 8080 100100 120120 150150 170170 200200 size made m fde fig. The blue line shows the trend of ade. Whue as the size decreases the trajectory distribution is incapable of modeling large enough amounts of data. ",
        "5 Conclusions": "In this paper we have proposed the concept of trajectory distributions with advantages in representing the randomness of trajectories and explored a new trajectory prediction method based on it.  experiments on public datasets show the effectiveness of our method. Our current work does not incorporate the physical environment but it is obvious that adding such information to our model is straightforward and convenient and is the direction of our future work. "
    },

}
ind = 0

class RPView(APIView):
    parser_classes = (MultiPartParser, FormParser)

    def get(self, request, *args, **kwargs):
        # rps = RP.objects.all()
        # serializer = RPSerializer(rps, many=True)
        # return Response(serializer.data)
        return Response(summ)


    def post(self, request, *args, **kwargs):
        rps_serializer = RPSerializer(data=request.data)
        if rps_serializer.is_valid():
            rps_serializer.save()
            # text = extract_text(rps_serializer.data['rp_file'])
            paper_content = get_section_summary(rps_serializer.data['rp_file'])
            global summ
            global ind
            # summ.append(paper_content)
            summ[ind] = paper_content
            ind += 1
            print("*******")
            print(len(summ))
            print("*******")
            return Response(paper_content, status=status.HTTP_201_CREATED)
        else:
            print('error', rps_serializer.errors)
            return Response(rps_serializer.errors, status=status.HTTP_400_BAD_REQUEST)

